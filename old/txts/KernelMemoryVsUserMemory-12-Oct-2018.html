<!DOCTYPE html>
<html lang="en">
   <head>
       <meta charset="utf-8">
       <link rel="shortcut icon" type="image/x-icon" href="../../images/favicon.ico">
       <title>KernelMemoryVsUserMemory 12 Oct 2018</title>
   </head>
    <style>

    a.link {
        border-bottom: 1px dashed #a30000;
        color: #a30000;
        text-decoration: none;
    }
    pre {
       width:650px;
       margin: 0 auto;
       font-size:12px; /* 13px will make it bold */
    }
    .code {
        color:white;
        border-radius:5px;
        background-color:#2d3238;
        padding:5px;
        overflow: auto; /* enables horizontal scroll bars to code blocks */
    }
    .center {
		display: inline-block;
		margin: 0 auto;
		max-width: 620px;
	}
    </style>

    <body>
        <pre>
<b>Today, I wanted to understand exactly how usermode memory is not shared among</b>
<b>other processes where as kernel memory is being shared between all the</b>
<b>processes.</b>

<b>To understand this we need to first understand how a process memory is actually</b>
<b>mapped to physical memory. To recap breifly every process which is executing on</b>
<b>the current core will have to map the its virutal memory using page tables via</b>
<b>its CR3 register. This mapping will make sure any virutal memory that the</b>
<b>processor refers to will be translated to physical memory appropriately.</b>

<b>In Windbg, Once you are on the required process context we can just use</b>
<b>1: kd> !process -1 0</b>
<b>PROCESS ffffbf0b7efa25c0</b>
    SessionId: 1  Cid: 1298    Peb: a5ae79d000  ParentCid: 1d48
    DirBase: 3addf000  ObjectTable: ffffd18c8159d4c0  HandleCount:  30.
    Image: ConsoleApplication1.exe

<b>The DirBase is nothing but the CR3 register.</b>

<b>Now any virutal address in the process can be translated to it physical memory</b>
<b>using</b>
<b>0: kd> !vtop 0 00007ff6d00d0a30</b>
<b>Amd64VtoP: Virt 00007ff6d00d0a30, pagedir 00000000161f7000</b>
<b>Amd64VtoP: PML4E 00000000161f77f8</b>
<b>Amd64VtoP: PDPE 000000001a066ed8</b>
<b>Amd64VtoP: PDE 000000002d227400</b>
<b>Amd64VtoP: PTE 000000000d528680</b>
<b>Amd64VtoP: Mapped phys 0000000028b4fa30</b>
<b>Virtual address 7ff6d00d0a30 translates to physical address 28b4fa30.</b>

<b>Before answering the begining question, we need to understand that by default</b>
<b>all modules (ntdll.dll/kernelbase.dll etc) gets physically mapped to the same</b>
<b>location. We can validate this by dumping the physical address of same function</b>
<b>(ntdll!RtlUserThreadStart) in two different processes. So there will be only one</b>
<b>copy for everything in physical memory. But when the content of these dlls</b>
<b>change in memory thats when the Memory manager will create a new copy in</b>
<b>physcial memory.</b>

<b>int g_global = 10;</b>
<b>int main()</b>
<b>{</b>
    DebugBreak();
    printf("\nExamine Before Modifying %d @ %p\n", g_global, &g_global);
    getchar();
<b>}</b>

<b>Application 1:</b>
<b>0: kd> g</b>
<b>Break instruction exception - code 80000003 (first chance)</b>
<b>KERNELBASE!DebugBreak [inlined in KERNELBASE!wil::details::DebugBreak+0x2]:</b>
<b>0033:00007ffc`79cb67e2 cc              int     3</b>
<b>0: kd> !process -1 0</b>
<b>PROCESS ffffbf0b7ed6a080</b>
    SessionId: 1  Cid: 18e8    Peb: 3ee4887000  ParentCid: 135c
    DirBase: 2649b000  ObjectTable: ffffd18c7f019800  HandleCount:  30.
    Image: ConsoleApplication1.exe

<b>0: kd> .reload</b>
<b>0: kd> x nt!NtCreateFile</b>
<b>fffff802`53da3b80 nt!NtCreateFile</b>
<b>0: kd> !vtop 0 fffff80253da3b80</b>
<b>Amd64VtoP: Virt fffff80253da3b80, pagedir 000000002649b000</b>
<b>Amd64VtoP: PML4E 000000002649bf80</b>
<b>Amd64VtoP: PDPE 0000000000949048</b>
<b>Amd64VtoP: PDE 000000000094a4f0</b>
<b>Amd64VtoP: PTE 0000000000954d18</b>
<b>Amd64VtoP: Mapped phys 00000000023a3b80</b>
<b>Virtual address fffff80253da3b80 translates to physical address 23a3b80.</b>
<b>0: kd> x ConsoleApplication1!g_global</b>
<b>00007ff7`e2490a30 ConsoleApplication1!g_global = 0n10</b>
<b>0: kd> !vtop 0 00007ff7e2490a30</b>
<b>Amd64VtoP: Virt 00007ff7e2490a30, pagedir 000000002649b000</b>
<b>Amd64VtoP: PML4E 000000002649b7f8</b>
<b>Amd64VtoP: PDPE 000000001e1d5ef8</b>
<b>Amd64VtoP: PDE 000000003c196890</b>
<b>Amd64VtoP: PTE 00000000346d7480</b>
<b>Amd64VtoP: Mapped phys 00000000115bca30</b>
<b>Virtual address 7ff7e2490a30 translates to physical address 115bca30.</b>
<b>0: kd> g</b>

<b>Application 2:</b>
<b>Break instruction exception - code 80000003 (first chance)</b>
<b>KERNELBASE!DebugBreak [inlined in KERNELBASE!wil::details::DebugBreak+0x2]:</b>
<b>0033:00007ffc`79cb67e2 cc              int     3</b>
<b>0: kd> !process -1 0</b>
<b>PROCESS ffffbf0b7efa25c0</b>
    SessionId: 1  Cid: 082c    Peb: 3fe88a9000  ParentCid: 1d48
    DirBase: 198a9000  ObjectTable: ffffd18c80c9a640  HandleCount:  30.
    Image: ConsoleApplication1.exe

<b>0: kd> .reload</b>
<b>0: kd> x nt!NtCreateFile</b>
<b>fffff802`53da3b80 nt!NtCreateFile</b>
<b>0: kd> !vtop 0 fffff80253da3b80</b>
<b>Amd64VtoP: Virt fffff80253da3b80, pagedir 00000000198a9000</b>
<b>Amd64VtoP: PML4E 00000000198a9f80</b>
<b>Amd64VtoP: PDPE 0000000000949048</b>
<b>Amd64VtoP: PDE 000000000094a4f0</b>
<b>Amd64VtoP: PTE 0000000000954d18</b>
<b>Amd64VtoP: Mapped phys 00000000023a3b80</b>
<b>Virtual address fffff80253da3b80 translates to physical address 23a3b80.</b>
<b>0: kd> x ConsoleApplication1!g_global</b>
<b>00007ff7`e2490a30 ConsoleApplication1!g_global = 0n10</b>
<b>0: kd> !vtop 0 00007ff7e2490a30</b>
<b>Amd64VtoP: Virt 00007ff7e2490a30, pagedir 00000000198a9000</b>
<b>Amd64VtoP: PML4E 00000000198a97f8</b>
<b>Amd64VtoP: PDPE 0000000029d4def8</b>
<b>Amd64VtoP: PDE 000000003e24e890</b>
<b>Amd64VtoP: PTE 000000001a24f480</b>
<b>Amd64VtoP: Mapped phys 0000000011134a30</b>
<b>Virtual address 7ff7e2490a30 translates to physical address 11134a30.</b>

<b>In the above listing both instances of the applicaiton the physical address for</b>
<b>nt!NtCreateFile is same 23a3b80. Where as physcial address of</b>
<b>ConsoleApplication1!g_global is different.</b>

<b>NOTE: Modifiying the memory content via windbg does not involve Memory Manager</b>
<b>and directly written to the physical memory. So the changed value might get</b>
<b>reflected even in the second process as well!</b>
        </pre>
        <div>
            <script src="https://utteranc.es/client.js"
                repo="vineelkovvuri/vineelkovvuri.github.io"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
            </script>
        </div>
    </body>
</html>
